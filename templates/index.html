<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>kube-bt-sync æ§åˆ¶å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .yaml-editor { font-family: monospace; font-size: 14px; width: 100%; height: 350px; background-color: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 4px; border: none; outline: none; resize: vertical;}
        .check-card { height: 100%; }
        .check-card p { margin: 8px 0; font-size: 14px; }
        .code-block { background: #282c34; color: #abb2bf; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 5px; word-break: break-all; }
        .el-card__body { padding: 15px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h2>ğŸš€ kube-bt-sync è¾¹ç¼˜ç½‘å…³åŒæ­¥ä¸­å¿ƒ</h2>
            <el-button type="primary" @click="openDialog" size="large"> + æš´éœ²æ–°æœåŠ¡</el-button>
        </div>

        <el-row :gutter="20" style="margin-bottom: 20px; display: flex; align-items: stretch;">
            <el-col :span="8">
                <el-card shadow="hover" class="check-card">
                    <template #header>
                        <div style="font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                            <span>ğŸŒ äº‘ç«¯å®å¡”èŠ‚ç‚¹</span>
                            <el-button size="small" type="primary" plain @click="checkSystem" :loading="checking">åˆ·æ–°</el-button>
                        </div>
                    </template>
                    <div v-if="sysStatus.baota">
                        <p><strong>æ¥å£åœ°å€ï¼š</strong> {{ sysStatus.baota.url }}</p>
                        <p><strong>è¿é€šçŠ¶æ€ï¼š</strong> 
                            <el-tag :type="sysStatus.baota.status === 'success' ? 'success' : 'danger'" size="small">
                                {{ sysStatus.baota.status === 'success' ? 'æ­£å¸¸è¿é€š' : 'è¿æ¥å¤±è´¥' }}
                            </el-tag>
                        </p>
                        <el-alert v-if="sysStatus.baota.status !== 'success'" :title="sysStatus.baota.msg" type="error" show-icon :closable="false" style="margin-top: 10px;"></el-alert>
                    </div>
                </el-card>
            </el-col>

            <el-col :span="8">
                <el-card shadow="hover" class="check-card">
                    <template #header><div style="font-weight: bold; padding: 4px 0;">ğŸ  å®¶åº­è¾¹ç¼˜èŠ‚ç‚¹ (DDNS)</div></template>
                    <div v-if="sysStatus.ddns">
                        <p><strong>DDNS åŸŸåï¼š</strong> {{ sysStatus.ddns.host || 'æœªé…ç½®' }}</p>
                        <p><strong>æ¢æµ‹çŠ¶æ€ï¼š</strong>
                            <el-tag :type="sysStatus.ddns.status === 'success' ? 'success' : (sysStatus.ddns.status === 'warning' ? 'warning' : 'danger')" size="small">
                                {{ sysStatus.ddns.msg }}
                            </el-tag>
                        </p>
                        <div v-if="sysStatus.ddns.status === 'success' || sysStatus.ddns.status === 'warning'" style="margin-top: 10px; padding: 8px; background: #f0f9eb; border-radius: 4px; border: 1px solid #e1f3d8;">
                            <span style="font-size: 13px; color: #67c23a; font-weight: bold;">ğŸ“ å½“å‰å…¬ç½‘ IPï¼š<br/>{{ sysStatus.ddns.ips.join(', ') }}</span>
                        </div>
                    </div>
                </el-card>
            </el-col>

            <el-col :span="8">
                <el-card shadow="hover" class="check-card">
                    <template #header><div style="font-weight: bold; padding: 4px 0;">ğŸš¢ K8s å†…éƒ¨åŸºç¡€è®¾æ–½</div></template>
                    <div v-if="sysStatus.k8s">
                        <p><strong>MetalLBï¼š</strong>
                            <el-tag :type="sysStatus.k8s.metallbInstalled ? 'success' : 'danger'" size="small">
                                {{ sysStatus.k8s.metallbInstalled ? 'å·²å®‰è£…å¹¶å°±ç»ª' : 'æœªæ£€æµ‹åˆ°ç»„ä»¶' }}
                            </el-tag>
                        </p>
                        <p><strong>Ingress æ§åˆ¶å™¨ï¼š</strong>
                            <el-tag :type="sysStatus.k8s.ingressInstalled ? 'success' : 'danger'" size="small">
                                {{ sysStatus.k8s.ingressInstalled ? 'å·²å®‰è£…å¹¶å°±ç»ª' : 'æœªæ£€æµ‹åˆ°ç»„ä»¶' }}
                            </el-tag>
                        </p>
                    </div>
                </el-card>
            </el-col>
        </el-row>

        <el-card class="box-card">
            <template #header>
                <div class="card-header" style="display: flex; justify-content: space-between;">
                    <span style="font-weight: bold;">ğŸ“‹ å·²æ‰˜ç®¡è·¯ç”±çŠ¶æ€</span>
                    <el-button style="padding: 3px 0" text @click="() => fetchStatus(false)">åˆ·æ–°æ•°æ®</el-button>
                </div>
            </template>
            <el-table :data="statusList" style="width: 100%" v-loading="loading">
                <el-table-column prop="namespace" label="å‘½åç©ºé—´" width="120"></el-table-column>
                <el-table-column prop="name" label="èµ„æºåç§°" width="180"></el-table-column>
                <el-table-column prop="domain" label="è®¿é—®åŸŸå">
                    <template #default="scope">
                        <el-link :type="scope.row.scheme === 'https' ? 'success' : 'primary'" :href="scope.row.scheme + '://' + scope.row.domain" target="_blank">
                            <span v-if="scope.row.scheme === 'https'">ğŸ”’ </span>
                            {{ scope.row.scheme }}://{{ scope.row.domain }}
                        </el-link>
                    </template>
                </el-table-column>
                <el-table-column prop="ddnsPort" label="å†…ç½‘å‡ºå£" width="90">
                    <template #default="scope"><el-tag type="info">{{ scope.row.ddnsPort }}</el-tag></template>
                </el-table-column>
                
                <el-table-column prop="status" label="è¿œç«¯åŒæ­¥è¿›åº¦" width="240">
                    <template #default="scope">
                        <el-tag :type="scope.row.status.includes('æœªé…ç½®è¯ä¹¦') ? 'danger' : (scope.row.status.includes('âœ…') ? 'success' : 'warning')" effect="dark">
                            {{ scope.row.status }}
                        </el-tag>
                    </template>
                </el-table-column>
                
                <el-table-column label="æ“ä½œ" width="120" align="center">
                    <template #default="scope">
                        <el-button type="danger" size="small" plain @click="prepareDelete(scope.row)">ç§»é™¤</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>

        <el-dialog v-model="dialogVisible" title="é…ç½® Ingress è§„åˆ™" width="650px" destroy-on-close>
            <el-tabs v-model="activeTab" @tab-change="handleTabChange">
                <el-tab-pane label="ğŸ“ è¡¨å•æ¨¡å¼ (æ–°æ‰‹å‹å¥½)" name="form">
                    <el-form :model="form" label-width="120px" style="margin-top: 15px;">
                        <el-form-item label="è§„åˆ™åç§°"><el-input v-model="form.name"></el-input></el-form-item>
                        
                        <el-form-item label="å®‰å…¨è®¿é—®">
                            <el-switch v-model="form.enableHttps" active-text="å¼€å¯ HTTPS (TLS)" inactive-text="çº¯ HTTP è®¿é—®"></el-switch>
                        </el-form-item>
                        
                        <el-form-item label="ä¸šåŠ¡åŸŸå"><el-input v-model="form.domain" placeholder="å¦‚: app.i4t.com"></el-input></el-form-item>
                        
                        <el-form-item label="å‘½åç©ºé—´ (NS)">
                            <el-select v-model="form.namespace" placeholder="è¯·é€‰æ‹© Namespace" filterable style="width: 100%;" @change="handleNamespaceChange">
                                <el-option v-for="ns in namespacesList" :key="ns" :label="ns" :value="ns"></el-option>
                            </el-select>
                        </el-form-item>
                        
                        <el-form-item label="åç«¯ Service">
                            <el-select v-model="form.serviceName" placeholder="è¯·é€‰æ‹©è¯¥ NS ä¸‹çš„ Service" filterable allow-create style="width: 100%;" @change="handleServiceChange">
                                <el-option v-for="svc in filteredServices" :key="svc.name" :label="svc.name" :value="svc.name"></el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="åç«¯ç«¯å£">
                            <el-select v-model="form.servicePort" placeholder="é€‰æ‹©æˆ–æ‰‹å¡«ç«¯å£" filterable allow-create style="width: 100%;">
                                <el-option v-for="p in availablePorts" :key="p" :label="p" :value="p">
                                    <span style="float: left">{{ p }}</span>
                                    <span style="float: right; color: #8492a6; font-size: 13px">è‡ªåŠ¨æ¢æµ‹</span>
                                </el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="æŒ‡å®š DDNS ç«¯å£"><el-input v-model="form.customPort" placeholder="ç•™ç©ºä½¿ç”¨å…¨å±€é…ç½®"></el-input></el-form-item>
                    </el-form>
                </el-tab-pane>
                <el-tab-pane label="ğŸ’» YAML æ¨¡å¼ (æå®¢ä¸“å±)" name="yaml">
                    <el-alert title="æ‚¨å¯ä»¥ç›´æ¥åœ¨æ­¤ä¿®æ”¹ YAML ç»“æ„ï¼Œæäº¤åå°†åŸæ ·åº”ç”¨åˆ° K8sã€‚" type="warning" :closable="false" style="margin-bottom: 10px;"></el-alert>
                    <textarea v-model="yamlContent" class="yaml-editor" spellcheck="false"></textarea>
                </el-tab-pane>
            </el-tabs>
            <template #footer>
                <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitConfig" :loading="submitLoading">ä¸‹å‘é…ç½®</el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="deleteDialogVisible" title="âš ï¸ åˆ é™¤è·¯ç”±ç¡®è®¤" width="450px" destroy-on-close>
            <div style="font-size: 15px; margin-bottom: 10px;">
                ç¡®å®šè¦ç§»é™¤ Ingress <strong style="color: #f56c6c;">{{ deleteForm.name }}</strong> å—ï¼Ÿ
            </div>
            <div style="background-color: #fdf6ec; padding: 15px; border-radius: 4px;">
                <el-checkbox v-model="deleteForm.deleteBaota" border size="large">
                    <span style="font-weight: bold;">åŒæ—¶æ¸…é™¤å®å¡”äº‘ç«¯é¢æ¿å¯¹åº”çš„ç«™ç‚¹</span>
                </el-checkbox>
            </div>
            <template #footer>
                <el-button @click="deleteDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="danger" @click="confirmDelete" :loading="deleteLoading">ç¡®è®¤åˆ é™¤</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const app = createApp({
            setup() {
                const statusList = ref([]);
                const loading = ref(false);
                const submitLoading = ref(false);
                const dialogVisible = ref(false);
                const activeTab = ref('form');
                const yamlContent = ref('');
                
                const sysStatus = ref({ baota: null, k8s: null, ddns: null });
                const checking = ref(false);
                const namespacesList = ref([]);
                const servicesList = ref([]);

                const deleteDialogVisible = ref(false);
                const deleteLoading = ref(false);
                const deleteForm = ref({ namespace: '', name: '', domain: '', deleteBaota: true });

                const form = ref({
                    name: 'my-app-ingress', namespace: 'default', domain: 'app.i4t.com',
                    serviceName: '', servicePort: '', customPort: '', enableHttps: true
                });

                const filteredServices = computed(() => {
                    if (!form.value.namespace) return servicesList.value;
                    return servicesList.value.filter(s => s.namespace === form.value.namespace);
                });

                const availablePorts = computed(() => {
                    const selected = servicesList.value.find(s => s.name === form.value.serviceName && s.namespace === form.value.namespace);
                    return selected && selected.ports ? selected.ports : [];
                });

                const handleNamespaceChange = () => { form.value.serviceName = ''; form.value.servicePort = ''; };
                const handleServiceChange = () => { if (availablePorts.value.length > 0) { form.value.servicePort = availablePorts.value[0]; } else { form.value.servicePort = 80; } };

                const fetchNamespacesAndServices = () => {
                    fetch('/api/namespaces').then(res => res.json()).then(data => namespacesList.value = data || []);
                    fetch('/api/services').then(res => res.json()).then(data => servicesList.value = data || []);
                };

                const checkSystem = () => {
                    checking.value = true;
                    fetch('/api/system/check').then(res => res.json()).then(data => {
                        sysStatus.value = data; checking.value = false;
                    }).catch(err => { ElementPlus.ElMessage.error('ç¯å¢ƒè¯·æ±‚å¤±è´¥'); checking.value = false; });
                };

                const fetchStatus = (isAutoPolling = false) => {
                    if (!isAutoPolling) loading.value = true;
                    fetch('/api/status').then(res => res.json()).then(data => {
                        statusList.value = data || []; 
                        if (!isAutoPolling) loading.value = false;
                        const hasPending = statusList.value.some(item => item.status.includes('â³'));
                        if (hasPending) { setTimeout(() => fetchStatus(true), 2000); }
                    }).catch(() => { if (!isAutoPolling) loading.value = false; });
                };

                const generateYamlFromForm = () => {
                    const secretName = form.value.domain.replace(/\./g, '-') + '-tls';
                    const ingress = {
                        apiVersion: 'networking.k8s.io/v1', kind: 'Ingress',
                        metadata: { name: form.value.name, namespace: form.value.namespace, annotations: { 'kube-bt-sync.io/baota-sync': 'true' }},
                        spec: { ingressClassName: 'nginx', rules: [{ host: form.value.domain, http: { paths: [{ path: '/', pathType: 'Prefix', backend: { service: { name: form.value.serviceName, port: { number: Number(form.value.servicePort) } } } }]}}]}
                    };
                    if (form.value.enableHttps) { ingress.spec.tls = [{ hosts: [form.value.domain], secretName: secretName }]; }
                    if (form.value.customPort) { ingress.metadata.annotations['kube-bt-sync.io/ddns-port'] = form.value.customPort; }
                    yamlContent.value = jsyaml.dump(ingress);
                };

                const handleTabChange = (name) => { if (name === 'yaml') generateYamlFromForm(); };

                const openDialog = () => { activeTab.value = 'form'; dialogVisible.value = true; fetchNamespacesAndServices(); };

                const submitConfig = () => {
                    submitLoading.value = true;
                    if (activeTab.value === 'form') generateYamlFromForm();
                    fetch('/api/ingress/yaml', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ yamlContent: yamlContent.value })
                    }).then(res => res.json()).then(data => {
                        submitLoading.value = false;
                        if(data.error) { ElementPlus.ElMessage.error(data.error); } 
                        else { ElementPlus.ElMessage.success(data.message); dialogVisible.value = false; fetchStatus(false); }
                    });
                };

                const prepareDelete = (row) => { deleteForm.value = { namespace: row.namespace, name: row.name, domain: row.domain, deleteBaota: true }; deleteDialogVisible.value = true; };

                const confirmDelete = () => {
                    deleteLoading.value = true;
                    fetch('/api/ingress/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(deleteForm.value) })
                    .then(res => res.json()).then(data => {
                        deleteLoading.value = false;
                        if(data.error) { ElementPlus.ElMessage.error(data.error); } 
                        else { ElementPlus.ElMessage.success(data.message); deleteDialogVisible.value = false; fetchStatus(false); }
                    });
                };

                onMounted(() => { fetchStatus(); checkSystem(); });
                
                return { statusList, loading, fetchStatus, dialogVisible, activeTab, form, yamlContent, handleTabChange, submitConfig, submitLoading, openDialog, sysStatus, checking, checkSystem, namespacesList, servicesList, filteredServices, handleNamespaceChange, availablePorts, handleServiceChange, deleteDialogVisible, deleteLoading, deleteForm, prepareDelete, confirmDelete };
            }
        });
        app.use(ElementPlus); app.mount('#app');
    </script>
</body>
</html>
